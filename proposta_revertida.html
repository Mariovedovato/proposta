<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proposta Técnica</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Estilos adicionais para garantir que o modal seja exibido corretamente */
        .fixed.inset-0 {
            z-index: 9999; /* Garante que o modal esteja acima de tudo */
        }
    </style>
    <!-- React CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel CDN - Essencial para interpretar JSX diretamente no navegador -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- html2canvas CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- jsPDF CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <!-- Todo o código React/JSX deve estar dentro de um script com type="text/babel" -->
    <script type="text/babel">
        // Importa React e os hooks necessários
        const { useState, useRef, useEffect } = React;

        // Função para formatar CNPJ/CPF e limitar a entrada
        const formatCnpjCpf = (value) => {
            if (!value) return '';
            let cleanedValue = value.replace(/\D/g, '');
            cleanedValue = cleanedValue.substring(0, 14);

            if (cleanedValue.length <= 11) {
                return cleanedValue
                    .replace(/(\d{3})(\d)/, '$1.$2')
                    .replace(/(\d{3})(\d)/, '$1.$2')
                    .replace(/(\d{3})(\d{1,2})$/, '$1-$2');
            } else {
                return cleanedValue
                    .replace(/^(\d{2})(\d)/, '$1.$2')
                    .replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3')
                    .replace(/\.(\d{3})(\d)/, '.$1/$2')
                    .replace(/(\d{4})(\d)/, '$1-$2');
            }
        };

        // Função para formatar valor monetário para exibição final (sempre 2 decimais, separador de milhares)
        const formatCurrencyDisplay = (num) => {
            let numericValue = typeof num === 'string' ? parseFloat(num.replace(/\./g, '').replace(',', '.')) : num;
            if (isNaN(numericValue)) {
                return '0,00';
            }
            return new Intl.NumberFormat('pt-BR', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(numericValue);
        };

        // Função para formatar a validade da proposta (apenas 2 dígitos numéricos)
        const formatTwoDigitNumberInput = (value) => {
            const cleanedValue = value.replace(/\D/g, ''); // Remove tudo que não é dígito
            return cleanedValue.substring(0, 2); // Limita a 2 dígitos
        };

        // Componente Modal de Entrada Genérico (para texto e CNPJ/CPF)
        const InputModal = ({ isOpen, onClose, title, value, onSave, type = 'text', formatFn = null }) => {
            console.log(`InputModal (${title}) isOpen:`, isOpen); // Debug log
            if (!isOpen) return null;

            const [inputValue, setInputValue] = useState(value);
            const inputRef = useRef(null);

            useEffect(() => {
                if (isOpen && inputRef.current) {
                    inputRef.current.focus();
                    // Se o valor inicial contém texto descritivo (ex: "10 dias úteis."), extrair apenas o número
                    if (title === "VALIDADE DA PROPOSTA") {
                        const numMatch = value.match(/^(\d+)/);
                        setInputValue(numMatch ? numMatch[1] : '');
                    } else {
                        setInputValue(value);
                    }
                }
            }, [isOpen, value, title]);

            const handleChange = (e) => {
                let newValue = e.target.value;
                if (formatFn) {
                    newValue = formatFn(newValue);
                }
                setInputValue(newValue.toUpperCase()); // Sempre caixa alta para estes campos
            };

            return (
                <div className="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm">
                        <h3 className="text-lg font-semibold mb-4 text-gray-800">{title}</h3>
                        <input
                            ref={inputRef}
                            type={type}
                            className="w-full p-3 border border-gray-300 rounded-md mb-4 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200"
                            value={inputValue}
                            onChange={handleChange}
                            placeholder={`Digite o ${title.toLowerCase()}`}
                        />
                        <div className="flex justify-end space-x-3">
                            <button
                                onClick={onClose}
                                className="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition duration-200 font-medium"
                            >
                                Cancelar
                            </button>
                            <button
                                onClick={() => {
                                    onSave(inputValue);
                                    onClose();
                                }}
                                className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition duration-200 font-medium shadow-md"
                            >
                                Salvar
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // Componente para seleção de observações
        const ObservationSelectModal = ({ isOpen, onClose, title, options, onSelect }) => {
            console.log(`ObservationSelectModal (${title}) isOpen:`, isOpen); // Debug log
            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm">
                        <h3 className="text-lg font-semibold mb-4 text-gray-800">{title}</h3>
                        <div className="flex flex-col space-y-3">
                            {options.map((option, index) => (
                                <button
                                    key={index}
                                    onClick={() => {
                                        onSelect(option);
                                        onClose();
                                    }}
                                    className="px-4 py-2 text-left bg-gray-100 text-gray-800 rounded-md hover:bg-blue-100 hover:text-blue-700 transition duration-200 font-medium border border-gray-200"
                                >
                                    {option}
                                </button>
                            ))}
                        </div>
                        <div className="flex justify-end mt-4">
                            <button
                                onClick={onClose}
                                className="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition duration-200 font-medium"
                            >
                                Fechar
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // Componente para seleção de descrição de serviço (agora usado para a tabela de valores estimados)
        const ServiceDescriptionSelectModal = ({ isOpen, onClose, title, options, onSelect }) => {
            console.log(`ServiceDescriptionSelectModal (${title}) isOpen:`, isOpen); // Debug log
            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-lg shadow-xl p-6 w-full max-w-md"> {/* Aumentado max-w para acomodar textos mais longos */}
                        <h3 className="text-lg font-semibold mb-4 text-gray-800">{title}</h3>
                        <div className="flex flex-col space-y-3">
                            {options.map((option, index) => (
                                <button
                                    key={index}
                                    onClick={() => {
                                        onSelect(option);
                                        onClose();
                                    }}
                                    className="px-4 py-2 text-left bg-gray-100 text-gray-800 rounded-md hover:bg-blue-100 hover:text-blue-700 transition duration-200 font-medium border border-gray-200"
                                >
                                    {option}
                                </button>
                            ))}
                        </div>
                        <div className="flex justify-end mt-4">
                            <button
                                onClick={onClose}
                                className="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition duration-200 font-medium"
                            >
                                Fechar
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // Novo componente para editar o valor e o tipo do valor
        const ValueEditModal = ({ isOpen, onClose, title, currentAmount, currentType, onSave }) => { // Adicionado 'title' aqui
            console.log(`ValueEditModal (${title}) isOpen:`, isOpen); // Debug log
            if (!isOpen) return null;

            const [rawAmount, setRawAmount] = useState(''); // Stores only the digits typed by the user
            const [tempType, setTempType] = useState(currentType);
            const inputRef = useRef(null);

            // Helper function to format raw digits for display during typing (no decimals, only thousands separators)
            const formatValueForTypingDisplay = (digits, type) => {
                if (digits === '') return '';

                let numericValue = parseInt(digits, 10);
                if (isNaN(numericValue)) {
                    numericValue = 0;
                }

                // Apply numeric limits
                if (type === 'Hora') {
                    const maxHora = 1000;
                    if (numericValue > maxHora) {
                        numericValue = maxHora;
                    }
                } else { // type === 'Pacote'
                    const maxPacote = 1000000;
                    if (numericValue > maxPacote) {
                        numericValue = maxPacote;
                    }
                }

                // Format only the integer part with thousands separators
                return new Intl.NumberFormat('pt-BR', {
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                }).format(numericValue);
            };

            // Effect to reset state when modal opens or type changes, and set focus/cursor
            useEffect(() => {
                if (isOpen) {
                    setTempType(currentType);
                    // When opening, initialize rawAmount from currentAmount (remove formatting and decimals)
                    // Example: "160,00" -> "160"
                    const initialRaw = currentAmount.replace(/\D/g, '').slice(0, -2); // Remove non-digits, then remove last two (decimals)
                    setRawAmount(initialRaw);

                    if (inputRef.current) {
                        inputRef.current.focus();
                        // Set cursor to the end after initial render/focus
                        const currentDisplayedValue = formatValueForTypingDisplay(initialRaw, currentType);
                        inputRef.current.value = currentDisplayedValue; // Explicitly set value for cursor positioning
                        inputRef.current.selectionStart = currentDisplayedValue.length;
                        inputRef.current.selectionEnd = currentDisplayedValue.length;
                    }
                }
            }, [isOpen, currentAmount, currentType]);

            // Effect to maintain cursor position at the end after rawAmount changes (due to typing)
            useEffect(() => {
                if (inputRef.current && isOpen) {
                    const newFormattedValue = formatValueForTypingDisplay(rawAmount, tempType);
                    inputRef.current.value = newFormattedValue; // Manually set value to ensure cursor position works
                    inputRef.current.selectionStart = newFormattedValue.length;
                    inputRef.current.selectionEnd = newFormattedValue.length;
                }
            }, [rawAmount, tempType, isOpen]); // Added isOpen to dependencies to re-run when modal state changes

            const handleInputChange = (e) => {
                let newRawValue = e.target.value.replace(/\D/g, ''); // Keep only digits

                // Apply character length limit based on type for the raw input
                if (tempType === 'Hora') {
                    newRawValue = newRawValue.substring(0, 4); // Max 4 digits for "1000"
                } else { // Pacote
                    newRawValue = newRawValue.substring(0, 7); // Max 7 digits for "1000000"
                }
                setRawAmount(newRawValue);
            };

            const handleTypeChange = (newType) => {
                setTempType(newType);
                setRawAmount('');
            };

            const handleSave = () => {
                let numericValue = parseInt(rawAmount, 10) || 0;

                // Apply limits before final formatting
                if (tempType === 'Hora') {
                    const maxHora = 1000;
                    if (numericValue > maxHora) {
                        numericValue = maxHora;
                    }
                } else { // Pacote
                    const maxPacote = 1000000;
                    if (numericValue > maxPacote) {
                        numericValue = maxPacote;
                    }
                }

                // Use formatCurrencyDisplay for the final saved value (adds ,00)
                const valueToSave = formatCurrencyDisplay(numericValue);
                onSave(valueToSave, tempType);
                onClose(); // This should definitely close the modal
            };

            const inputMaxLength = tempType === 'Hora' ? 4 : 7;

            return (
                <div className="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm">
                        <h3 className="text-lg font-semibold mb-4 text-gray-800">{title}</h3> {/* Título adicionado aqui */}

                        {/* Seleção do Tipo de Valor */}
                        <div className="mb-4">
                            <label className="block text-gray-700 text-sm font-bold mb-2">TIPO DE VALOR:</lab